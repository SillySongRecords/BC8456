<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browncow Distribution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .theme-purple { background-color: #5a4ae3; }
        .theme-text { color: #5a4ae3; }
        .theme-border { border-color: #5a4ae3; }
        .btn-primary {
            background-color: #5a4ae3;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4b3bc5;
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .view {
            display: none;
        }
        .active-view {
            display: block;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom progress bar style */
        .progress-bar {
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #5a4ae3;
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <div id="auth-view" class="view active-view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div id="login-form">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">
                        <span class="theme-text">Browncow</span> Distribution
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">Welcome back! Please sign in.</p>
                </div>
                <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-purple-500 focus:border-purple-500 focus:z-10 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-purple-500 focus:border-purple-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 btn-primary">
                            Sign in
                        </button>
                    </div>
                </form>
                <div class="text-sm text-center mt-4">
                    <a href="#" id="show-signup" class="font-medium theme-text hover:text-purple-500">
                        Don't have an account? Sign up
                    </a>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">
                        <span class="theme-text">Browncow</span> Distribution
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">Create your account to get started.</p>
                </div>
                <form class="mt-8 space-y-6" onsubmit="handleSignup(event)">
                    <div class="rounded-md shadow-sm">
                        <input id="signup-name" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm mb-2" placeholder="Full Name or Artist Name">
                        <input id="signup-email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm mb-2" placeholder="Email address">
                        <input id="signup-password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Password (min. 6 characters)">
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 btn-primary">
                            Sign up
                        </button>
                    </div>
                </form>
                <div class="text-sm text-center mt-4">
                    <a href="#" id="show-login" class="font-medium theme-text hover:text-purple-500">
                        Already have an account? Sign in
                    </a>
                </div>
            </div>
        </div>
    </div>


    <div id="app-view" class="view">
        <div class="flex h-screen bg-gray-100">
            <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
                <div class="flex items-center justify-center h-16 bg-white border-b">
                    <h1 class="text-2xl font-bold theme-text">Browncow</h1>
                </div>
                <div class="flex flex-col flex-grow p-4">
                    <nav id="user-nav" class="flex-grow space-y-2">
                        </nav>
                    <nav id="admin-nav" class="flex-grow space-y-2 hidden">
                        </nav>
                    <div class="mt-auto">
                        <a href="#" onclick="handleLogout()" class="flex items-center px-4 py-2 mt-2 text-sm font-medium text-gray-600 rounded-md hover:bg-gray-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>

            <div class="flex flex-col flex-1 overflow-y-auto">
                <header class="flex items-center justify-between h-16 bg-white border-b px-6">
                    <div class="flex items-center">
                         <button id="mobile-menu-button" class="md:hidden mr-4 text-gray-600">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <h1 id="page-title" class="text-xl font-semibold text-gray-800">Dashboard</h1>
                    </div>
                    <div class="flex items-center">
                        <span id="user-greeting" class="text-sm text-gray-600"></span>
                    </div>
                </header>

                <main class="p-6 md:p-10 space-y-8">
                    <div id="content-area">
                        </div>
                </main>
            </div>
        </div>
        
        <div id="mobile-menu" class="fixed inset-0 flex z-40 md:hidden hidden">
            <div class="fixed inset-0 bg-black opacity-25" id="mobile-menu-overlay"></div>
            <div class="relative flex-1 flex flex-col max-w-xs w-full bg-white">
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button id="mobile-menu-close" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
                    <div class="flex-shrink-0 flex items-center px-4">
                        <h1 class="text-2xl font-bold theme-text">Browncow</h1>
                    </div>
                    <nav id="mobile-user-nav" class="mt-5 px-2 space-y-1">
                        </nav>
                       <nav id="mobile-admin-nav" class="mt-5 px-2 space-y-1 hidden">
                        </nav>
                </div>
                 <div class="flex-shrink-0 flex border-t p-4">
                    <a href="#" onclick="handleLogout()" class="flex-shrink-0 group block">
                        <div class="flex items-center">
                            <div>
                                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-700 group-hover:text-gray-900">Logout</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase and App imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, onSnapshot, updateDoc, orderBy, serverTimestamp, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: Replace with your Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // IMPORTANT: Replace with your Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME";  
        const CLOUDINARY_UPLOAD_PRESET = "YOUR_UPLOAD_PRESET";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentUserData = null; // Store user's Firestore data
        let isAdmin = false;

        // --- UI Elements ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');
        const userGreeting = document.getElementById('user-greeting');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- Navigation Setup ---
        // MODIFIED: Added Settings link for users
        const userNavLinks = [
            { name: 'Dashboard', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', view: 'user-dashboard' },
            { name: 'Create Release', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>', view: 'create-release' },
            { name: 'My Releases', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path></svg>', view: 'my-releases' },
            { name: 'Analytics', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>', view: 'analytics' },
            { name: 'Payouts', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', view: 'payouts' },
            { name: 'Settings', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', view: 'settings' },
        ];
        // MODIFIED: Added Manage Payouts for admins
        const adminNavLinks = [
            { name: 'All Releases', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>', view: 'admin-releases' },
            { name: 'Manage Payouts', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', view: 'admin-payouts' },
            { name: 'Manage Users', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', view: 'admin-users' },
        ];

        function createNavLink(link, index, isAdminLink = false) {
            const isActive = index === 0;
            return `
                <a href="#" data-view="${link.view}" class="nav-link ${isActive ? 'bg-purple-100 theme-text' : 'text-gray-600'} flex items-center px-4 py-2 text-sm font-medium rounded-md hover:bg-gray-200">
                    ${link.icon}
                    ${link.name}
                </a>`;
        }
        
        // --- Authentication Logic ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Login successful!');
            } catch (error) {
                console.error("Login Error:", error);
                 if (error.code === 'auth/invalid-credential') {
                    showToast('Invalid email or password.', 'error');
                } else {
                    showToast(`Error: ${error.message}`, 'error');
                }
            } finally {
                showLoading(false);
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();
            showLoading(true);
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    createdAt: serverTimestamp(),
                    isAdmin: false,
                    balance: 0,
                    paymentInfo: null
                });
                showToast('Signup successful! Welcome.');
            } catch (error) {
                console.error("Signup Error:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        window.handleLogout = async () => {
            showLoading(true);
            await signOut(auth);
            currentUser = null;
            currentUserData = null;
            isAdmin = false;
            document.getElementById('user-nav').innerHTML = '';
            document.getElementById('admin-nav').innerHTML = '';
            showToast('Logged out successfully.');
            showLoading(false);
        };
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showLoading(true);
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);

                // Use onSnapshot to keep user data in sync, especially the balance
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        isAdmin = currentUserData.isAdmin || false;

                        // Re-render dashboard or current view if balance updates
                        const currentActiveLink = document.querySelector('.nav-link.bg-purple-100');
                        if (currentActiveLink && currentActiveLink.dataset.view === 'user-dashboard') {
                             renderUserDashboard();
                        }
                    }
                });

                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    isAdmin = currentUserData.isAdmin || false;
                }
                
                if(!user.displayName && userDoc.exists()){
                     await updateProfile(user, { displayName: userDoc.data().name });
                }

                userGreeting.textContent = `Hello, ${user.displayName || user.email}`;
                setupAppUI();
                authView.classList.remove('active-view');
                appView.classList.add('active-view');
                showLoading(false);
            } else {
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                authView.classList.add('active-view');
                appView.classList.remove('active-view');
            }
        });

        // --- UI & View Management ---
        function setupAppUI() {
            const userNavContainer = document.getElementById('user-nav');
            const adminNavContainer = document.getElementById('admin-nav');
            const mobileUserNavContainer = document.getElementById('mobile-user-nav');
            const mobileAdminNavContainer = document.getElementById('mobile-admin-nav');

            if (isAdmin) {
                userNavContainer.classList.add('hidden');
                mobileUserNavContainer.classList.add('hidden');
                adminNavContainer.classList.remove('hidden');
                mobileAdminNavContainer.classList.remove('hidden');
                adminNavContainer.innerHTML = adminNavLinks.map((link, i) => createNavLink(link, i, true)).join('');
                mobileAdminNavContainer.innerHTML = adminNavLinks.map((link, i) => createNavLink(link, i, true)).join('');
                navigateTo('admin-releases');
            } else {
                adminNavContainer.classList.add('hidden');
                mobileAdminNavContainer.classList.add('hidden');
                userNavContainer.classList.remove('hidden');
                mobileUserNavContainer.classList.remove('hidden');
                userNavContainer.innerHTML = userNavLinks.map((link, i) => createNavLink(link, i)).join('');
                mobileUserNavContainer.innerHTML = userNavLinks.map((link, i) => createNavLink(link, i)).join('');
                navigateTo('user-dashboard');
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('data-view');
                    navigateTo(viewName);
                });
            });
        }
        
        window.navigateTo = (viewName, id = null) => {
            const link = [...userNavLinks, ...adminNavLinks].find(l => l.view === viewName);
            if(link) pageTitle.textContent = link.name;
            else if (viewName === 'release-details') pageTitle.textContent = 'Release Details';
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-purple-100', 'theme-text'));
            document.querySelectorAll(`.nav-link[data-view="${viewName}"]`).forEach(l => l.classList.add('bg-purple-100', 'theme-text'));
            
            switch(viewName) {
                case 'user-dashboard': renderUserDashboard(); break;
                case 'create-release': renderCreateReleaseForm(); break;
                case 'my-releases': renderMyReleases(); break;
                case 'release-details': renderReleaseDetails(id); break; 
                case 'analytics': renderAnalytics(); break;
                case 'payouts': renderPayouts(); break;
                case 'settings': renderSettings(); break;
                case 'admin-releases': renderAdminReleases(); break;
                case 'admin-payouts': renderAdminPayouts(); break;
                case 'admin-users': renderAdminUsers(); break;
            }
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }
        
        // --- View Renderers ---
        
        function renderUserDashboard() {
            const balance = currentUserData?.balance ? currentUserData.balance.toFixed(2) : '0.00';

            contentArea.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold text-gray-700">Current Balance</h3><p class="text-3xl font-bold theme-text mt-2">$${balance}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold text-gray-700">Total Releases</h3><p id="total-releases" class="text-3xl font-bold text-gray-800 mt-2">Loading...</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-lg font-semibold text-gray-700">Live on Stores</h3><p id="live-releases" class="text-3xl font-bold text-gray-800 mt-2">Loading...</p></div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Releases</h3>
                    <div id="recent-releases-list" class="space-y-4"><p>Loading recent releases...</p></div>
                </div>
            `;
            
            const q = query(collection(db, "releases"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const releases = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if (document.getElementById('total-releases')) {
                    document.getElementById('total-releases').textContent = releases.length;
                    document.getElementById('live-releases').textContent = releases.filter(r => r.status === 'delivered').length;
                }
                let recentHtml = releases.length === 0 ? `<p class="text-gray-500">You haven't created any releases yet. Click 'Create Release' to get started!</p>` : releases.slice(0, 5).map(createReleaseListItem).join('');
                if (document.getElementById('recent-releases-list')) {
                    document.getElementById('recent-releases-list').innerHTML = recentHtml;
                }
            });
        }
        
        function renderCreateReleaseForm() {
            const dsps = ['24-7', 'Amazon', 'Anghami', 'Audiomack', 'Awa', 'Boomplay', 'Deezer', 'Facebook', 'Flo', 'iHeartRadio', 'iMusica', 'iTunes/Apple Music', 'Joox', 'KKBOX', 'Lickd', 'Mixcloud', 'NetEase', 'Pandora', 'Peloton', 'Resso', 'Rhapsody / Napster', 'Saavn', 'Snap', 'Soundcloud', 'Spotify', 'Tencent', 'Tidal', 'TikTok', 'YouTube Music'];
            const eligibleDsps = ['Facebook Fingerprinting', 'YouTube Content ID'];
            const genres = ['Pop', 'Rock', 'Hip-Hop/Rap', 'Electronic', 'R&B', 'Country', 'Jazz', 'Other'];

            contentArea.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Release</h2>
                    <form id="create-release-form">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">1. Uploads</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Audio File (WAV, FLAC, MP3)</label>
                                    <input type="file" id="audio-file" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    <div id="audio-upload-progress" class="mt-2 h-2.5 w-full progress-bar hidden"><div class="progress-bar-inner"></div></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cover Art (3000x3000px, JPG)</label>
                                    <input type="file" id="artwork-file" required accept="image/jpeg" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    <div id="artwork-upload-progress" class="mt-2 h-2.5 w-full progress-bar hidden"><div class="progress-bar-inner"></div></div>
                                    <img id="artwork-preview" class="mt-4 rounded-lg w-32 h-32 object-cover hidden" src="#" alt="Artwork Preview" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Documentation (optional)</label>
                                    <input type="file" id="docs-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    <div id="docs-upload-progress" class="mt-2 h-2.5 w-full progress-bar hidden"><div class="progress-bar-inner"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6 border-t pt-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">2. Release Information</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-sm font-medium text-gray-700">Song Title</label><input type="text" id="song-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Primary Artist</label><input type="text" id="primary-artist" required placeholder="Your artist name" value="${currentUser.displayName || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Featured Artists (optional)</label><input type="text" id="featured-artists" placeholder="e.g., Artist A, Artist B" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Record Label</label><input type="text" id="record-label" placeholder="Your label name" value="${currentUser.displayName || ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Genre</label>
                                    <select id="genre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                                        ${genres.map(g => `<option value="${g}">${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="other-genre-container" class="hidden"><label class="block text-sm font-medium text-gray-700">Specify Genre</label><input type="text" id="other-genre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Has this been released before?</label>
                                    <div class="mt-2 space-x-4"><label><input type="radio" name="released_before" value="no" checked> No</label><label><input type="radio" name="released_before" value="yes"> Yes</label></div>
                                </div>
                                <div id="original-release-date-container" class="hidden"><label class="block text-sm font-medium text-gray-700">Original Release Date</label><input type="date" id="original-release-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">UPC (optional)</label><input type="text" id="upc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">ISRC (optional)</label><input type="text" id="isrc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Release Date</label><input type="date" id="release-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"></div>
                            </div>
                        </div>
                        <div class="mb-6 border-t pt-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">3. Artist Profiles</h3>
                            <div class="space-y-4">
                                ${['Spotify', 'Apple Music', 'YouTube Music'].map(platform => `
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">${platform} Artist URL</label>
                                        <div class="flex items-center gap-2 mt-1">
                                            <input type="url" id="profile-${platform.toLowerCase().replace(' ', '-')}" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                                            <button type="button" onclick="alert('Contact support to have a new artist profile created.')" class="btn-secondary text-xs px-3 py-2 rounded-md whitespace-nowrap">Create New Profile</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                         <div class="mb-6 border-t pt-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">4. Store Selection</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                    ${dsps.map(dsp => `<label class="flex items-center space-x-2"><input type="checkbox" name="dsp" value="${dsp}" checked class="rounded theme-border text-purple-600 focus:ring-purple-500"> <span class="text-sm">${dsp}</span></label>`).join('')}
                                </div>
                                <h4 class="text-md font-medium text-gray-600 pt-4">Rights Management</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     ${eligibleDsps.map(dsp => `<label class="flex items-center space-x-2"><input type="checkbox" name="dsp" value="${dsp}" class="dsp-eligible rounded theme-border text-purple-600 focus:ring-purple-500"> <span class="text-sm">${dsp}</span></label>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div id="content-id-agreement" class="hidden my-6 p-4 border-l-4 border-yellow-400 bg-yellow-50">
                            <h4 class="font-bold text-yellow-800">Content ID Agreement</h4>
                            <div class="mt-2">
                                <label class="flex items-start">
                                    <input type="checkbox" id="content-id-checkbox" class="mt-1 rounded theme-border text-purple-600 focus:ring-purple-500">
                                    <span class="ml-2 text-sm text-yellow-700">I confirm that my song is 100% original, contains no loops or samples, and that I own all rights to the audio. I understand that fraudulent uploads will result in account termination and liability for any legal fees.</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-8 pt-5 border-t">
                             <button type="submit" id="submit-release-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium btn-primary">Submit Release</button>
                        </div>
                    </form>
                </div>
            `;
            // Add event listeners after rendering the form
            document.getElementById('artwork-file').addEventListener('change', handleArtworkPreview);
            document.getElementById('create-release-form').addEventListener('submit', handleCreateRelease);
            document.getElementById('genre').addEventListener('change', (e) => {
                document.getElementById('other-genre-container').classList.toggle('hidden', e.target.value !== 'Other');
            });
            document.querySelectorAll('input[name="released_before"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('original-release-date-container').classList.toggle('hidden', e.target.value !== 'yes');
                });
            });
            document.querySelectorAll('.dsp-eligible').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const isEligibleSelected = Array.from(document.querySelectorAll('.dsp-eligible:checked')).length > 0;
                    document.getElementById('content-id-agreement').classList.toggle('hidden', !isEligibleSelected);
                });
            });
        }
        
        async function handleCreateRelease(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-release-btn');

            // Content ID validation
            const isContentIdVisible = !document.getElementById('content-id-agreement').classList.contains('hidden');
            if (isContentIdVisible && !document.getElementById('content-id-checkbox').checked) {
                showToast("You must agree to the Content ID terms to proceed.", 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            showLoading(true);

            try {
                const audioFile = document.getElementById('audio-file').files[0];
                const artworkFile = document.getElementById('artwork-file').files[0];
                const docsFile = document.getElementById('docs-file').files[0];

                if (!audioFile || !artworkFile) throw new Error("Audio and Artwork files are required.");

                const audioUrl = await uploadToCloudinary(audioFile, 'audio-upload-progress', 'video');
                const artworkUrl = await uploadToCloudinary(artworkFile, 'artwork-upload-progress', 'image');
                let docsUrl = null;
                if(docsFile) {
                    docsUrl = await uploadToCloudinary(docsFile, 'docs-upload-progress', 'raw');
                }

                const genre = document.getElementById('genre').value;
                const releaseData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    songTitle: document.getElementById('song-title').value,
                    primaryArtist: document.getElementById('primary-artist').value,
                    featuredArtists: document.getElementById('featured-artists').value,
                    releaseDate: document.getElementById('release-date').value,
                    genre: genre === 'Other' ? document.getElementById('other-genre').value : genre,
                    recordLabel: document.getElementById('record-label').value,
                    releasedBefore: document.querySelector('input[name="released_before"]:checked').value === 'yes',
                    originalReleaseDate: document.querySelector('input[name="released_before"]:checked').value === 'yes' ? document.getElementById('original-release-date').value : null,
                    upc: document.getElementById('upc').value,
                    isrc: document.getElementById('isrc').value,
                    artistProfiles: {
                        spotify: document.getElementById('profile-spotify').value,
                        appleMusic: document.getElementById('profile-apple-music').value,
                        youtubeMusic: document.getElementById('profile-youtube-music').value
                    },
                    audioUrl,
                    artworkUrl,
                    docsUrl,
                    stores: Array.from(document.querySelectorAll('input[name="dsp"]:checked')).map(el => el.value),
                    status: 'submitted',
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, "releases"), releaseData);
                showToast('Release submitted successfully!');
                navigateTo('my-releases');

            } catch (error) {
                console.error("Release creation error:", error);
                showToast(`Error: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Release';
            } finally {
                showLoading(false);
            }
        }
        
        async function renderMyReleases() {
            contentArea.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">My Releases</h3>
                        <button onclick="navigateTo('create-release')" class="btn-primary text-sm font-medium py-2 px-4 rounded-md">New Release</button>
                    </div>
                    <div id="my-releases-list" class="space-y-4"><p>Loading your releases...</p></div>
                </div>
            `;
            
            const q = query(collection(db, "releases"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const releases = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const listEl = document.getElementById('my-releases-list');
                if (listEl) {
                    listEl.innerHTML = releases.length > 0 
                        ? releases.map(createReleaseListItem).join('')
                        : `<p class="text-gray-500">No releases found. Create your first one!</p>`;
                }
            });
        }
        
        // MODIFIED: Added read-only state for locked releases
        async function renderReleaseDetails(releaseId) {
            showLoading(true);
            try {
                const releaseDoc = await getDoc(doc(db, "releases", releaseId));
                if (!releaseDoc.exists()) {
                    contentArea.innerHTML = `<p>Release not found.</p>`;
                    return;
                }
                const release = { id: releaseDoc.id, ...releaseDoc.data() };
                const isLocked = ['approved', 'delivered'].includes(release.status) && !isAdmin;
                const disabledAttr = isLocked ? 'disabled' : '';
                
                contentArea.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
                        <div class="flex justify-between items-start">
                             <h2 class="text-3xl font-bold text-gray-800 mb-4">Release Details</h2>
                             <span class="text-sm font-medium px-2 py-1 rounded-full ${getStatusColor(release.status)} bg-opacity-20">${release.status}</span>
                        </div>
                        <form id="release-details-form">
                           <div class="space-y-4">
                                <div><label class="font-semibold">Song Title:</label><input type="text" value="${release.songTitle}" ${disabledAttr} class="w-full p-2 border rounded-md bg-gray-50"></div>
                                <div><label class="font-semibold">Primary Artist:</label><input type="text" value="${release.primaryArtist}" ${disabledAttr} class="w-full p-2 border rounded-md bg-gray-50"></div>
                                <div><label class="font-semibold">Release Date:</label><input type="date" value="${release.releaseDate}" ${disabledAttr} class="w-full p-2 border rounded-md bg-gray-50"></div>
                                </div>

                           ${isLocked ? `<div class="mt-6 p-3 text-sm bg-blue-50 text-blue-700 rounded-md">This release is locked. To request a metadata update, please contact support.</div>` : ''}

                           ${isAdmin ? renderAdminControls(release.id, release.status) : ''}
                        </form>
                    </div>
                `;
            } catch(error) {
                console.error("Error rendering release details: ", error);
                contentArea.innerHTML = `<p>Could not load release details.</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function renderAnalytics() {
            contentArea.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md text-center"><h2 class="text-2xl font-bold text-gray-800 mb-4">Analytics</h2><p class="text-gray-500">Detailed stream and revenue analytics will be available here soon.</p></div>`;
        }
        
        // NEW: Functional Payouts view for users
        function renderPayouts() {
             const balance = currentUserData?.balance ? currentUserData.balance.toFixed(2) : '0.00';
            if (!currentUserData?.paymentInfo) {
                contentArea.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Payouts</h2>
                        <p class="text-gray-500 mb-4">Please set up your payment information before requesting a payout.</p>
                        <button onclick="navigateTo('settings')" class="btn-primary py-2 px-4 rounded-md">Go to Settings</button>
                    </div>
                `;
                return;
            }
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800">Request Payout</h3>
                        <p class="mt-4">Current Balance: <strong class="theme-text text-2xl">$${balance}</strong></p>
                        <form id="payout-request-form" class="mt-4 space-y-4">
                            <div>
                                <label for="payout-amount" class="block text-sm font-medium text-gray-700">Amount (USD)</label>
                                <input type="number" id="payout-amount" min="1" step="0.01" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                            </div>
                            <button type="submit" class="w-full btn-primary py-2 px-4 rounded-md">Request Payout</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Payout History</h3>
                        <div id="payout-history-list" class="space-y-3">Loading history...</div>
                    </div>
                </div>
            `;
            document.getElementById('payout-request-form').addEventListener('submit', handleRequestPayout);
            // Load payout history
            const q = query(collection(db, "payouts"), where("userId", "==", currentUser.uid), orderBy("requestedAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const historyList = document.getElementById('payout-history-list');
                const payouts = querySnapshot.docs.map(doc => doc.data());
                if (payouts.length === 0) {
                    historyList.innerHTML = `<p class="text-gray-500">No payout history.</p>`;
                    return;
                }
                historyList.innerHTML = payouts.map(p => `
                    <div class="p-3 bg-gray-50 rounded-md">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-lg">$${p.amount.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Requested on ${new Date(p.requestedAt.seconds * 1000).toLocaleDateString()}</p>
                            </div>
                            <span class="capitalize font-bold text-sm ${p.status === 'approved' ? 'text-green-600' : p.status === 'rejected' ? 'text-red-600' : 'text-yellow-600'}">${p.status}</span>
                        </div>
                        ${p.status === 'approved' ? `<p class="text-xs mt-1 text-green-700">Your payment will be in your selected account in 1-7 business days.</p>` : ''}
                        ${p.status === 'rejected' && p.reason ? `<p class="text-xs mt-1 text-red-700">Reason: ${p.reason}</p>` : ''}
                    </div>
                `).join('');
            });
        }
        
        // NEW: Settings view for payment info
        async function renderSettings() {
            const paymentInfo = currentUserData?.paymentInfo;
            const isLocked = !!paymentInfo;
            const disabledAttr = isLocked ? 'disabled' : '';

            contentArea.innerHTML = `
                 <div class="bg-white p-8 rounded-xl shadow-md max-w-xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Payment Settings</h2>
                    <form id="payment-settings-form">
                        <div class="space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Payout Method</label>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="payout_method" value="paypal" ${disabledAttr} ${paymentInfo?.method === 'paypal' ? 'checked' : ''}> PayPal</label>
                                    <label><input type="radio" name="payout_method" value="check" ${disabledAttr} ${paymentInfo?.method === 'check' ? 'checked' : ''}> Paper Check</label>
                                </div>
                            </div>
                            <div id="paypal-fields" class="${paymentInfo?.method !== 'paypal' ? 'hidden' : ''}">
                                <label class="block text-sm font-medium text-gray-700">PayPal Email</label>
                                <input type="email" id="paypal-email" value="${paymentInfo?.email || ''}" ${disabledAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                            </div>
                            <div id="check-fields" class="${paymentInfo?.method !== 'check' ? 'hidden' : ''} space-y-2">
                                <div><label class="text-sm font-medium">Full Legal Name</label><input type="text" id="legal-name" value="${paymentInfo?.name || ''}" ${disabledAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                <div><label class="text-sm font-medium">Mailing Address</label><textarea id="mailing-address" ${disabledAttr} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${paymentInfo?.address || ''}</textarea></div>
                            </div>
                        </div>
                        ${!isLocked ? `<button type="submit" class="mt-6 w-full btn-primary py-2 px-4 rounded-md">Save Information</button>` : ''}
                        ${isLocked ? `<div class="mt-6 p-3 text-sm bg-blue-50 text-blue-700 rounded-md">To change your payment information, please contact support.</div>` : ''}
                    </form>
                </div>
            `;

            document.querySelectorAll('input[name="payout_method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('paypal-fields').classList.toggle('hidden', e.target.value !== 'paypal');
                    document.getElementById('check-fields').classList.toggle('hidden', e.target.value !== 'check');
                });
            });

            document.getElementById('payment-settings-form').addEventListener('submit', handleSavePaymentInfo);
        }

        async function renderAdminReleases() {
            contentArea.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">All Releases</h3>
                    <div id="admin-releases-list" class="space-y-4"><p>Loading all releases...</p></div>
                </div>
            `;

            const q = query(collection(db, "releases"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const releases = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const listEl = document.getElementById('admin-releases-list');
                if(listEl) {
                   listEl.innerHTML = releases.length > 0 
                        ? releases.map(release => createReleaseListItem(release, true)).join('')
                        : `<p class="text-gray-500">No releases have been submitted yet.</p>`;
                }
            });
        }
        
        // NEW: Admin view for managing payouts
        function renderAdminPayouts() {
             contentArea.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Payouts</h3>
                    <div id="admin-payouts-list" class="space-y-4"><p>Loading pending payouts...</p></div>
                </div>
            `;
            const q = query(collection(db, "payouts"), where("status", "==", "pending"), orderBy("requestedAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const listEl = document.getElementById('admin-payouts-list');
                const payouts = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if (payouts.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500">No pending payout requests.</p>`;
                    return;
                }
                listEl.innerHTML = payouts.map(p => `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-lg">$${p.amount.toFixed(2)} requested by <strong class="theme-text">${p.userName}</strong></p>
                                <p class="text-xs text-gray-500">User Balance: $${p.userBalance.toFixed(2)} | Requested on ${new Date(p.requestedAt.seconds * 1000).toLocaleDateString()}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="handleApprovePayout('${p.id}', '${p.userId}', ${p.amount})" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded">Approve</button>
                                <button onclick="handleRejectPayout('${p.id}')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded">Reject</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        async function renderAdminUsers() {
            contentArea.innerHTML = `...`; // Same as before
        }
        
        // --- Helper & Logic Functions ---

        async function handleSavePaymentInfo(e) {
            e.preventDefault();
            const method = document.querySelector('input[name="payout_method"]:checked').value;
            let paymentData = { method };

            if (method === 'paypal') {
                paymentData.email = document.getElementById('paypal-email').value;
                if (!paymentData.email) { showToast('PayPal email is required.', 'error'); return; }
            } else if (method === 'check') {
                paymentData.name = document.getElementById('legal-name').value;
                paymentData.address = document.getElementById('mailing-address').value;
                if (!paymentData.name || !paymentData.address) { showToast('Full name and address are required.', 'error'); return; }
            }
            
            showLoading(true);
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { paymentInfo: paymentData });
                showToast('Payment information saved successfully!');
                renderSettings(); // Re-render to lock the form
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function handleRequestPayout(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('payout-amount').value);
            const balance = currentUserData?.balance || 0;
            if (isNaN(amount) || amount <= 0) {
                showToast('Please enter a valid amount.', 'error');
                return;
            }
            if (amount > balance) {
                showToast('Requested amount exceeds your current balance.', 'error');
                return;
            }

            showLoading(true);
            try {
                await addDoc(collection(db, "payouts"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    amount: amount,
                    status: 'pending',
                    userBalance: balance, // Store balance at time of request
                    requestedAt: serverTimestamp()
                });
                showToast('Payout request submitted successfully.');
                document.getElementById('payout-request-form').reset();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Admin payout action functions
        window.handleApprovePayout = async (payoutId, userId, amount) => {
            if (!confirm('Are you sure you want to approve this payout? This will deduct from the user balance.')) return;
            showLoading(true);
            try {
                const userRef = doc(db, "users", userId);
                const payoutRef = doc(db, "payouts", payoutId);

                const userDoc = await getDoc(userRef);
                if (userDoc.data().balance < amount) {
                    throw new Error("User has insufficient funds.");
                }

                await updateDoc(userRef, { balance: increment(-amount) });
                await updateDoc(payoutRef, { status: 'approved' });
                showToast('Payout approved and user balance updated.');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        window.handleRejectPayout = async (payoutId) => {
            const reason = prompt("Please provide a reason for rejecting this payout request:");
            if (!reason) {
                showToast("Rejection cancelled. A reason is required.", "error");
                return;
            }
            showLoading(true);
            try {
                const payoutRef = doc(db, "payouts", payoutId);
                await updateDoc(payoutRef, { status: 'rejected', reason: reason });
                showToast('Payout request rejected.');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        function uploadToCloudinary(file, progressElementId, resourceType = 'auto') {
            return new Promise((resolve, reject) => {
                if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) return reject(new Error("Cloudinary configuration is missing."));
                const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;
                const xhr = new XMLHttpRequest();
                const fd = new FormData();
                const progressContainer = document.getElementById(progressElementId);
                const progressBar = progressContainer.querySelector('.progress-bar-inner');
                progressContainer.classList.remove('hidden');
                xhr.open('POST', url, true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                    }
                };
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if(xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error(`Upload failed: ${xhr.statusText}`));
                        }
                    }
                };
                fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                fd.append('file', file);
                fd.append('resource_type', resourceType);
                xhr.send(fd);
            });
        }
        
        function handleArtworkPreview(event) {
            const preview = document.getElementById('artwork-preview');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }
        
        function createReleaseListItem(release, showUserName = false) {
             return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer" onclick="navigateTo('release-details', '${release.id}')"><div class="flex items-center"><img src="${release.artworkUrl}" class="w-12 h-12 rounded-md object-cover mr-4" alt="Artwork"><div><p class="font-semibold text-gray-800">${release.songTitle}</p><p class="text-sm text-gray-500">${release.primaryArtist} ${showUserName ? `<span class="ml-2 text-xs">by <strong>${release.userName}</strong></span>` : ''}</p></div></div><div class="text-right"><span class="text-sm font-medium px-2 py-1 rounded-full ${getStatusColor(release.status)} bg-opacity-20">${release.status}</span><p class="text-xs text-gray-400 mt-1">${release.releaseDate}</p></div></div>`;
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'submitted': return 'text-blue-600 bg-blue-100';
                case 'reviewing': return 'text-yellow-600 bg-yellow-100';
                case 'approved': return 'text-green-600 bg-green-100';
                case 'delivered': return 'text-purple-600 bg-purple-100';
                case 'rejected': return 'text-red-600 bg-red-100';
                default: return 'text-gray-600 bg-gray-100';
            }
        }
        
        function renderAdminControls(releaseId, currentStatus) {
            const possibleActions = ['approved', 'reviewing', 'delivered', 'rejected'];
            return `<div class="mt-6 border-t pt-6"><h3 class="text-lg font-semibold text-gray-700 mb-2">Admin Actions</h3><p class="text-sm text-gray-500 mb-3">Change the status of this release.</p><div class="flex items-center gap-2"><select id="status-select" class="rounded-md border-gray-300">${possibleActions.map(action => `<option value="${action}" ${action === currentStatus ? 'selected' : ''}>${action.charAt(0).toUpperCase() + action.slice(1)}</option>`).join('')}</select><button onclick="updateReleaseStatus('${releaseId}')" class="btn-primary py-2 px-4 text-sm rounded-md">Update Status</button></div></div>`;
        }

        window.updateReleaseStatus = async (releaseId) => {
            const newStatus = document.getElementById('status-select').value;
            showLoading(true);
            try {
                await updateDoc(doc(db, "releases", releaseId), { status: newStatus });
                showToast('Release status updated successfully!');
                navigateTo('release-details', releaseId);
            } catch(error) { showToast('Failed to update status.', 'error'); } 
            finally { showLoading(false); }
        }
        
        window.toggleAdmin = async (userId, currentIsAdmin) => {
             // Function remains the same
        };


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
            showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            
            const mobileMenuBtn = document.getElementById('mobile-menu-button');
            const mobileMenuCloseBtn = document.getElementById('mobile-menu-close');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
            mobileMenuCloseBtn.addEventListener('click', () => mobileMenu.classList.add('hidden'));
            mobileMenuOverlay.addEventListener('click', () => mobileMenu.classList.add('hidden'));
        });
    </script>
</body>
</html>
