<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browncow Distribution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .theme-purple { background-color: #5a4ae3; }
        .theme-text { color: #5a4ae3; }
        .theme-border { border-color: #5a4ae3; }
        .btn-primary {
            background-color: #5a4ae3;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4b3bc5;
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            font-weight: 600;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .view {
            display: none;
        }
        .active-view {
            display: block;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom form field style for consistency */
        .input-field {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            border-radius: 0.375rem;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .input-field:focus {
             border-color: #5a4ae3;
             --tw-ring-color: #5a4ae3;
        }
        .form-checkbox, .form-radio {
            color: #5a4ae3;
        }
        .form-checkbox:focus, .form-radio:focus {
            --tw-ring-color: #5a4ae3;
        }
        .th {
             padding: 0.75rem 1.5rem;
             text-align: left;
             font-size: 0.75rem;
             font-weight: 500;
             color: #6b7280;
             text-transform: uppercase;
             letter-spacing: 0.05em;
        }
        .td {
            padding: 1rem 1.5rem;
            white-space: nowrap;
            font-size: 0.875rem;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <div id="auth-view" class="view active-view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div id="login-form">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">
                        <span class="theme-text">Browncow</span> Distribution
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">Welcome back! Please sign in.</p>
                </div>
                <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-purple-500 focus:border-purple-500 focus:z-10 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-purple-500 focus:border-purple-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md btn-primary">
                            Sign in
                        </button>
                    </div>
                </form>
                <div class="text-sm text-center mt-4">
                    <a href="#" onclick="event.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden');" class="font-medium theme-text hover:text-purple-500">
                        Don't have an account? Sign up
                    </a>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                 <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">
                        <span class="theme-text">Browncow</span> Distribution
                    </h2>
                    <p class="mt-2 text-sm text-gray-600">Create your account to get started.</p>
                </div>
                <form class="mt-8 space-y-6" onsubmit="handleSignup(event)">
                    <div class="rounded-md shadow-sm space-y-3">
                        <input id="signup-name" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Full Name or Artist Name">
                        <input id="signup-email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Email address">
                        <input id="signup-password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Password (min. 6 characters)">
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md btn-primary">
                            Sign up
                        </button>
                    </div>
                </form>
                <div class="text-sm text-center mt-4">
                    <a href="#" onclick="event.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden');" class="font-medium theme-text hover:text-purple-500">
                        Already have an account? Sign in
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="app-view" class="view">
        <div class="flex h-screen bg-gray-100">
            <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
                <div class="flex items-center justify-center h-16 bg-white border-b">
                    <h1 class="text-2xl font-bold theme-text">Browncow</h1>
                </div>
                <div class="flex flex-col flex-grow p-4">
                    <nav id="user-nav" class="flex-grow space-y-2"></nav>
                    <nav id="admin-nav" class="flex-grow space-y-2 hidden"></nav>
                    <div class="mt-auto">
                        <a href="#" onclick="handleLogout()" class="flex items-center px-4 py-2 mt-2 text-sm font-medium text-gray-600 rounded-md hover:bg-gray-200">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>

            <div class="flex flex-col flex-1 overflow-y-auto">
                <header class="flex items-center justify-between h-16 bg-white border-b px-6">
                    <div class="flex items-center">
                         <button id="mobile-menu-button" class="md:hidden mr-4 text-gray-600">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                         </button>
                        <h1 id="page-title" class="text-xl font-semibold text-gray-800">Dashboard</h1>
                    </div>
                    <div class="flex items-center">
                        <span id="user-greeting" class="text-sm text-gray-600"></span>
                    </div>
                </header>

                <main id="content-area-wrapper" class="p-6 md:p-10">
                    <div id="content-area" class="space-y-8">
                        </div>
                </main>
            </div>
        </div>
        
        <div id="mobile-menu" class="fixed inset-0 flex z-40 md:hidden hidden">
            <div class="fixed inset-0 bg-black opacity-25" id="mobile-menu-overlay"></div>
            <div class="relative flex-1 flex flex-col max-w-xs w-full bg-white">
                <div class="absolute top-0 right-0 -mr-12 pt-2">
                    <button id="mobile-menu-close" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="flex-1 h-0 pt-5 pb-4 overflow-y-auto">
                    <div class="flex-shrink-0 flex items-center px-4">
                        <h1 class="text-2xl font-bold theme-text">Browncow</h1>
                    </div>
                    <nav id="mobile-user-nav" class="mt-5 px-2 space-y-1"></nav>
                    <nav id="mobile-admin-nav" class="mt-5 px-2 space-y-1 hidden"></nav>
                </div>
                 <div class="flex-shrink-0 flex border-t p-4">
                    <a href="#" onclick="handleLogout()" class="flex-shrink-0 group block">
                        <div class="flex items-center">
                           <p class="text-sm font-medium text-gray-700 group-hover:text-gray-900">Logout</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase and App imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, onSnapshot, updateDoc, orderBy, serverTimestamp, deleteDoc, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const CLOUDINARY_CLOUD_NAME = "YOUR_CLOUD_NAME";
        const CLOUDINARY_UPLOAD_PRESET = "YOUR_UPLOAD_PRESET";

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentUserData = null; // Store user data from Firestore
        let isAdmin = false;

        // --- UI ELEMENTS ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        let contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');
        const userGreeting = document.getElementById('user-greeting');
        const loadingOverlay = document.getElementById('loading-overlay');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- NAVIGATION SETUP ---
        const userNavLinks = [
            { name: 'Dashboard', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', view: 'user-dashboard' },
            { name: 'Create Release', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>', view: 'create-release' },
            { name: 'My Releases', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 6l12-3"></path></svg>', view: 'my-releases' },
            { name: 'Analytics', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>', view: 'analytics' },
            { name: 'Payouts', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', view: 'payouts' },
        ];
        const adminNavLinks = [
            { name: 'All Releases', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>', view: 'admin-releases' },
            { name: 'Manage Payouts', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', view: 'admin-payouts' },
            { name: 'Manage Users', icon: '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', view: 'admin-users' },
        ];

        function createNavLink(link) {
            return `
                <a href="#" data-view="${link.view}" class="nav-link text-gray-600 flex items-center px-4 py-2 text-sm font-medium rounded-md hover:bg-gray-200">
                    ${link.icon}
                    ${link.name}
                </a>`;
        }
        
        // --- AUTHENTICATION & STATE MANAGEMENT ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Login successful!');
            } catch (error) {
                console.error("Login Error:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();
            showLoading(true);
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (password.length < 6) {
                showToast('Password must be at least 6 characters long.', 'error');
                showLoading(false);
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    createdAt: serverTimestamp(),
                    isAdmin: false,
                    balance: 0
                });
                showToast('Signup successful! Welcome.');
            } catch (error) {
                console.error("Signup Error:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };
        
        window.handleLogout = async () => {
            showLoading(true);
            await signOut(auth);
            currentUser = null;
            currentUserData = null;
            isAdmin = false;
            document.location.reload(); // Reload to clear state
        };
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                showLoading(true);
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                
                onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        currentUserData = { id: doc.id, ...doc.data() };
                        isAdmin = currentUserData.isAdmin || false;
                        userGreeting.textContent = `Hello, ${user.displayName || user.email}`;
                    }
                });

                const initialUserDoc = await getDoc(userDocRef);
                if (initialUserDoc.exists()) {
                     if(!user.displayName){
                        await updateProfile(user, { displayName: initialUserDoc.data().name });
                    }
                    setupAppUI();
                    authView.classList.remove('active-view');
                    appView.classList.add('active-view');
                }
                showLoading(false);
            } else {
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                authView.classList.add('active-view');
                appView.classList.remove('active-view');
            }
        });

        // --- UI & VIEW MANAGEMENT ---
        function setupAppUI() {
            const userNavContainer = document.getElementById('user-nav');
            const adminNavContainer = document.getElementById('admin-nav');
            const mobileUserNavContainer = document.getElementById('mobile-user-nav');
            const mobileAdminNavContainer = document.getElementById('mobile-admin-nav');
            const mobileMenu = document.getElementById('mobile-menu');

            const linksToRender = isAdmin ? adminNavLinks : userNavLinks;
            const defaultView = isAdmin ? 'admin-releases' : 'user-dashboard';

            const navHtml = linksToRender.map(createNavLink).join('');
            
            if (isAdmin) {
                userNavContainer.classList.add('hidden');
                mobileUserNavContainer.classList.add('hidden');
                adminNavContainer.classList.remove('hidden');
                mobileAdminNavContainer.classList.remove('hidden');
                adminNavContainer.innerHTML = navHtml;
                mobileAdminNavContainer.innerHTML = navHtml;
            } else {
                adminNavContainer.classList.add('hidden');
                mobileAdminNavContainer.classList.add('hidden');
                userNavContainer.classList.remove('hidden');
                mobileUserNavContainer.classList.remove('hidden');
                userNavContainer.innerHTML = navHtml;
                mobileUserNavContainer.innerHTML = navHtml;
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('data-view');
                    navigateTo(viewName);
                    mobileMenu.classList.add('hidden');
                });
            });

            // Set up mobile menu toggles
            document.getElementById('mobile-menu-button').onclick = () => mobileMenu.classList.remove('hidden');
            document.getElementById('mobile-menu-close').onclick = () => mobileMenu.classList.add('hidden');
            document.getElementById('mobile-menu-overlay').onclick = () => mobileMenu.classList.add('hidden');
            
            navigateTo(defaultView);
        }
        
        function navigateTo(viewName, id = null, options = {}) {
            // Update active nav link style
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-purple-100', 'theme-text'));
            document.querySelectorAll(`.nav-link[data-view="${viewName}"]`).forEach(l => l.classList.add('bg-purple-100', 'theme-text'));

            const link = [...userNavLinks, ...adminNavLinks].find(l => l.view === viewName);
            if(link) pageTitle.textContent = link.name;
            else if (viewName === 'release-details') pageTitle.textContent = 'Release Details';
            
            // Clear content area to remove old event listeners
            contentArea.innerHTML = '';
            
            switch(viewName) {
                case 'user-dashboard': renderUserDashboard(); break;
                case 'create-release': renderCreateReleaseForm(); break;
                case 'my-releases': renderMyReleases(); break;
                case 'release-details': renderReleaseDetails(id, options.isReadOnly); break;
                case 'analytics': renderAnalytics(); break;
                case 'payouts': renderPayouts(); break;
                case 'admin-releases': renderAdminReleases(); break;
                case 'admin-payouts': renderAdminPayouts(); break;
                case 'admin-users': renderAdminUsers(); break;
            }
        }

        function showLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }

        // --- EVENT HANDLERS ---
        document.body.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (actionTarget) {
                e.preventDefault();
                handleAction(actionTarget.dataset.action, actionTarget.dataset);
            }
        });

        document.body.addEventListener('change', (e) => {
            const changeTarget = e.target.closest('[data-change-handler]');
            if (changeTarget) {
                handleFieldChange(changeTarget.id, changeTarget.value);
            }
        });

        function handleAction(action, dataset) {
            const { id, userId, amount } = dataset;
            switch (action) {
                case 'view-release-readonly':
                    navigateTo('release-details', id, { isReadOnly: true });
                    break;
                case 'view-release-editable':
                    navigateTo('release-details', id, { isReadOnly: false });
                    break;
                case 'submit-release':
                    handleCreateRelease();
                    break;
                case 'save-payment-info':
                    handleSavePaymentInfo();
                    break;
                case 'request-payout':
                    handleRequestPayout();
                    break;
                case 'approve-payout':
                    if (confirm('Are you sure you want to approve this payout? This action cannot be undone.')) {
                        handleApprovePayout(id, userId, parseFloat(amount));
                    }
                    break;
                case 'reject-payout':
                    const reason = prompt('Please provide a reason for rejecting this payout request:');
                    if (reason) {
                        handleRejectPayout(id, reason);
                    }
                    break;
            }
        }
        
        function handleFieldChange(id, value) {
            switch (id) {
                case 'previously-released-yes':
                case 'previously-released-no':
                    document.getElementById('original-release-date-wrapper').classList.toggle('hidden', id === 'previously-released-no');
                    break;
                case 'genre':
                    const otherGenreWrapper = document.getElementById('other-genre-wrapper');
                    const otherGenreInput = document.getElementById('other-genre');
                    if (value === 'Other') {
                        otherGenreWrapper.classList.remove('hidden');
                        otherGenreInput.required = true;
                    } else {
                        otherGenreWrapper.classList.add('hidden');
                        otherGenreInput.required = false;
                    }
                    break;
                case 'payment-method':
                     document.getElementById('paypal-fields').classList.toggle('hidden', value !== 'paypal');
                     document.getElementById('check-fields').classList.toggle('hidden', value !== 'check');
                     break;
                default: // For monetization checkboxes
                    if (id.startsWith('eligible-dsps-')) {
                        const monetizationWrapper = document.getElementById('monetization-consent-wrapper');
                        const isMonetizationSelected = document.querySelector('#eligible-dsps-fb:checked') || document.querySelector('#eligible-dsps-yt:checked');
                        monetizationWrapper.classList.toggle('hidden', !isMonetizationSelected);
                        document.getElementById('monetization-consent').required = isMonetizationSelected;
                    }
            }
        }


        // --- VIEW RENDERERS ---
        
        function renderCreateReleaseForm(releaseData = {}, isReadOnly = false) {
            const dsps = ['24-7', 'Amazon', 'Anghami', 'Audiomack', 'Awa', 'Boomplay', 'Deezer', 'Facebook', 'Flo', 'iHeartRadio', 'iMusica', 'iTunes/Apple Music', 'Joox', 'KKBOX', 'Lickd', 'Mixcloud', 'NetEase', 'Pandora', 'Peloton', 'Resso', 'Rhapsody / Napster', 'Saavn', 'Snap', 'Soundcloud', 'Spotify', 'Tencent', 'Tidal', 'TikTok', 'YouTube Music'];
            const eligibleDsps = [{ id: 'eligible-dsps-fb', name: 'Facebook Fingerprinting' }, { id: 'eligible-dsps-yt', name: 'YouTube Content ID' }];
            const genres = ['Pop', 'Rock', 'Hip-Hop/Rap', 'Electronic', 'R&B', 'Country', 'Jazz', 'Other'];
            const disabledAttr = isReadOnly ? 'disabled' : '';

            contentArea.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-md max-w-4xl mx-auto">
                    <form id="release-form" class="space-y-8">
                        ${isReadOnly ? `<div class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md">
                            <p class="font-bold">This release has been delivered.</p>
                            <p>To request a metadata update, please contact support.</p>
                        </div>` : ''}

                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">1. Files</h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Audio File (WAV, FLAC, MP3)</label>
                                    <input type="file" id="audio-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" ${disabledAttr}>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cover Art (3000x3000px, JPG)</label>
                                    <input type="file" id="artwork-file" accept="image/jpeg" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" ${disabledAttr}>
                                    <img id="artwork-preview" class="mt-4 rounded-lg w-32 h-32 object-cover ${releaseData.artworkUrl ? '' : 'hidden'}" src="${releaseData.artworkUrl || '#'}" alt="Artwork Preview" />
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Documentation (Optional)</label>
                                    <input type="file" id="docs-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" ${disabledAttr}>
                                </div>
                            </div>
                        </div>

                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">2. Release Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-sm font-medium text-gray-700">Song Title</label><input type="text" id="song-title" value="${releaseData.songTitle || ''}" required class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">Primary Artist</label><input type="text" id="primary-artist" value="${releaseData.primaryArtist || currentUser.displayName || ''}" required class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">Featured Artists (optional)</label><input type="text" id="featured-artists" value="${releaseData.featuredArtists || ''}" placeholder="e.g., Artist A, Artist B" class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">Release Date</label><input type="date" id="release-date" value="${releaseData.releaseDate || ''}" required class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">Record Label</label><input type="text" id="record-label" value="${releaseData.recordLabel || currentUser.displayName || ''}" required class="input-field" ${disabledAttr}></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Genre</label>
                                    <select id="genre" data-change-handler="true" required class="input-field" ${disabledAttr}>
                                        ${genres.map(g => `<option ${releaseData.genre === g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="other-genre-wrapper" class="${releaseData.genre === 'Other' ? '' : 'hidden'}"><label class="block text-sm font-medium text-gray-700">Specify Genre</label><input type="text" id="other-genre" value="${releaseData.otherGenre || ''}" class="input-field" ${disabledAttr}></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Has this been released before?</label>
                                    <div class="mt-2 space-x-4">
                                        <label class="inline-flex items-center"><input type="radio" data-change-handler="true" name="previously-released" id="previously-released-yes" value="yes" ${releaseData.previouslyReleased ? 'checked' : ''} class="form-radio" ${disabledAttr}> <span class="ml-2">Yes</span></label>
                                        <label class="inline-flex items-center"><input type="radio" data-change-handler="true" name="previously-released" id="previously-released-no" value="no" ${!releaseData.previouslyReleased ? 'checked' : ''} class="form-radio" ${disabledAttr}> <span class="ml-2">No</span></label>
                                    </div>
                                </div>
                                <div id="original-release-date-wrapper" class="${releaseData.previouslyReleased ? '' : 'hidden'}"><label class="block text-sm font-medium text-gray-700">Original Release Date</label><input type="date" id="original-release-date" value="${releaseData.originalReleaseDate || ''}" class="input-field" ${disabledAttr}></div>
                            </div>
                        </div>

                         <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold mb-4 text-gray-700">3. Artist Profiles & Codes</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-sm font-medium text-gray-700">Spotify Profile URL</label><input type="url" id="spotify-url" value="${releaseData.spotifyUrl || ''}" placeholder="http://googleusercontent.com/spotify.com/..." required class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">Apple Music Profile URL</label><input type="url" id="apple-music-url" value="${releaseData.appleMusicUrl || ''}" placeholder="https://music.apple.com/..." required class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">YouTube Music Profile URL</label><input type="url" id="youtube-music-url" value="${releaseData.youtubeMusicUrl || ''}" placeholder="http://googleusercontent.com/youtube.com/..." required class="input-field" ${disabledAttr}></div>
                                <p class="text-xs text-gray-500 md:col-span-2">If you don't have a profile, one will be created. Please enter "NEW" in the URL field.</p>
                                <div><label class="block text-sm font-medium text-gray-700">UPC (Optional)</label><input type="text" id="upc" value="${releaseData.upc || ''}" class="input-field" ${disabledAttr}></div>
                                <div><label class="block text-sm font-medium text-gray-700">ISRC (Optional)</label><input type="text" id="isrc" value="${releaseData.isrc || ''}" class="input-field" ${disabledAttr}></div>
                            </div>
                        </div>
                        
                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">4. Distribution Outlets</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${dsps.map(dsp => `<div><label class="inline-flex items-center"><input type="checkbox" name="dsps" value="${dsp}" class="form-checkbox" ${releaseData.dsps?.includes(dsp) ? 'checked' : ''} ${disabledAttr}> <span class="ml-2 text-sm">${dsp}</span></label></div>`).join('')}
                            </div>
                            <h3 class="text-md font-semibold mt-6 mb-2 text-gray-700">Monetization</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${eligibleDsps.map(dsp => `<div><label class="inline-flex items-center"><input type="checkbox" data-change-handler="true" name="eligibleDsps" id="${dsp.id}" value="${dsp.name}" class="form-checkbox" ${releaseData.eligibleDsps?.includes(dsp.name) ? 'checked' : ''} ${disabledAttr}> <span class="ml-2 text-sm">${dsp.name}</span></label></div>`).join('')}
                            </div>
                            <div id="monetization-consent-wrapper" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-md hidden">
                                <label class="flex items-start">
                                    <input type="checkbox" id="monetization-consent" class="form-checkbox h-5 w-5 text-purple-600 mt-1" ${disabledAttr} ${releaseData.monetizationConsent ? 'checked' : ''}>
                                    <span class="ml-3 text-sm text-gray-700">
                                        <span class="font-bold">I acknowledge and confirm</span> that everything in my song is original, no copyrighted loops or samples were used, and that I have 100% of the rights to the audio. I understand that if I am caught uploading fraudulent material, my account will be terminated and I will be responsible for any and all legal fees that may arise.
                                    </span>
                                </label>
                            </div>
                        </div>

                        ${!isReadOnly ? `<div class="mt-8 flex justify-end">
                            <button type="button" data-action="submit-release" class="btn-primary font-bold py-2 px-6 rounded-lg">Submit Release</button>
                        </div>` : ''}
                    </form>
                </div>
            `;
            // Manually trigger change events to set initial state of conditional fields
            document.getElementById('genre')?.dispatchEvent(new Event('change', { bubbles: true }));
            document.querySelector('[name="eligibleDsps"]')?.dispatchEvent(new Event('change', { bubbles: true }));
        }

        async function renderReleaseDetails(releaseId, isReadOnly = true) {
            showLoading(true);
            try {
                const releaseDoc = await getDoc(doc(db, "releases", releaseId));
                if (releaseDoc.exists()) {
                    renderCreateReleaseForm(releaseDoc.data(), isReadOnly);
                } else {
                    contentArea.innerHTML = `<p>Release not found.</p>`;
                    showToast('Could not find the specified release.', 'error');
                }
            } catch (error) {
                console.error("Error fetching release details: ", error);
                contentArea.innerHTML = `<p>Error loading release details.</p>`;
            } finally {
                showLoading(false);
            }
        }

        function renderMyReleases() {
            contentArea.innerHTML = `<div id="my-releases-list" class="bg-white p-6 rounded-xl shadow-md"><p>Loading your releases...</p></div>`;
            const q = query(collection(db, "releases"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const releasesList = document.getElementById('my-releases-list');
                if (!releasesList) return;

                if (snapshot.empty) {
                    releasesList.innerHTML = `<p class="text-gray-500">You haven't created any releases yet.</p>`;
                    return;
                }

                releasesList.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="th">Title</th><th class="th">Artist</th><th class="th">Release Date</th><th class="th">Status</th><th class="th">Action</th>
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${snapshot.docs.map(doc => {
                                    const r = { id: doc.id, ...doc.data() };
                                    return `<tr>
                                        <td class="td font-medium text-gray-900">${r.songTitle}</td><td class="td">${r.primaryArtist}</td><td class="td">${r.releaseDate}</td>
                                        <td class="td"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(r.status)}">${r.status}</span></td>
                                        <td class="td"><button data-action="view-release-readonly" data-id="${r.id}" class="theme-text hover:text-purple-800">View Details</button></td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            });
        }

        async function renderPayouts() {
            const userData = currentUserData;
            if (!userData) {
                 contentArea.innerHTML = `<p>Could not load user data.</p>`;
                 return;
            }

            contentArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold text-gray-800">Your Balance</h3>
                            <p class="text-4xl font-bold theme-text mt-2">$${(userData.balance || 0).toFixed(2)}</p>
                            <div class="mt-6">
                                ${(userData.paymentInfo && userData.paymentInfo.method) 
                                    ? `<form id="payout-request-form">
                                            <h4 class="text-lg font-semibold text-gray-700">Request Payout</h4>
                                            <div class="mt-4 flex items-center gap-4">
                                                <input type="number" id="payout-amount" min="1" max="${userData.balance || 0}" step="0.01" class="input-field w-48" placeholder="Amount" required>
                                                <button type="button" data-action="request-payout" class="btn-primary font-bold py-2 px-6 rounded-lg">Request</button>
                                            </div>
                                       </form>`
                                    : `<div class="p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-700 rounded-md">
                                        <p class="font-bold">Please set up your payment information to request a payout.</p>
                                       </div>`
                                }
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                             <h3 class="text-xl font-semibold text-gray-800 mb-4">Payout History</h3>
                             <div id="payout-history-list">Loading history...</div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Payment Information</h3>
                            ${renderPaymentInfoForm(userData.paymentInfo)}
                        </div>
                    </div>
                </div>`;

            const historyList = document.getElementById('payout-history-list');
            const q = query(collection(db, "payouts"), where("userId", "==", currentUser.uid), orderBy("requestedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    historyList.innerHTML = `<p class="text-gray-500">No payout requests found.</p>`;
                    return;
                }
                historyList.innerHTML = snapshot.docs.map(doc => {
                    const p = doc.data();
                    const requestedDate = p.requestedAt?.toDate().toLocaleDateString();
                    let statusHtml = `<span class="font-semibold text-yellow-600">Pending</span>`;
                    if (p.status === 'approved') {
                        statusHtml = `<div class="text-green-600"><p class="font-semibold">Approved</p><p class="text-xs">Payment will arrive in 1-7 business days.</p></div>`;
                    } else if (p.status === 'rejected') {
                        statusHtml = `<div class="text-red-600"><p class="font-semibold">Rejected</p><p class="text-xs">Reason: ${p.reason || 'No reason provided.'}</p></div>`;
                    }
                    return `
                        <div class="flex justify-between items-center py-3 border-b">
                            <div>
                                <p class="font-bold text-lg">$${p.amount.toFixed(2)}</p>
                                <p class="text-sm text-gray-500">Requested on ${requestedDate}</p>
                            </div>
                            <div>${statusHtml}</div>
                        </div>`;
                }).join('');
            });
        }

        function renderPaymentInfoForm(paymentInfo = {}) {
            const isSaved = paymentInfo && paymentInfo.method;
            if (isSaved) {
                return `
                    <div class="space-y-2 text-sm text-gray-700">
                        <p><strong>Method:</strong> ${paymentInfo.method === 'paypal' ? 'PayPal' : 'Paper Check'}</p>
                        ${paymentInfo.method === 'paypal'
                            ? `<p><strong>Email:</strong> ${paymentInfo.paypalEmail}</p>`
                            : `<p><strong>Name:</strong> ${paymentInfo.legalName}</p>
                               <p><strong>Address:</strong> ${paymentInfo.mailingAddress}</p>`
                        }
                    </div>
                    <p class="mt-4 text-xs p-2 bg-gray-100 rounded">To change your payment information, please contact support.</p>
                `;
            } else {
                return `
                    <form id="payment-info-form" class="space-y-4">
                        <div>
                            <label for="payment-method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="payment-method" data-change-handler="true" class="input-field">
                                <option value="paypal">PayPal</option>
                                <option value="check">Paper Check</option>
                            </select>
                        </div>
                        <div id="paypal-fields">
                            <label for="paypal-email" class="block text-sm font-medium text-gray-700">PayPal Email</label>
                            <input type="email" id="paypal-email" class="input-field">
                        </div>
                        <div id="check-fields" class="hidden space-y-2">
                            <div>
                                <label for="legal-name" class="block text-sm font-medium text-gray-700">Full Legal Name</label>
                                <input type="text" id="legal-name" class="input-field">
                            </div>
                            <div>
                                <label for="mailing-address" class="block text-sm font-medium text-gray-700">Mailing Address</label>
                                <textarea id="mailing-address" rows="3" class="input-field"></textarea>
                            </div>
                        </div>
                        <button type="button" data-action="save-payment-info" class="w-full btn-primary font-bold py-2 px-4 rounded-lg">Save Information</button>
                    </form>
                `;
            }
        }

        function renderAdminPayouts() {
            contentArea.innerHTML = `<div class="space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4">Pending Payout Requests</h3>
                     <div id="pending-payouts-list">Loading...</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4">Payout History</h3>
                     <div id="processed-payouts-list">Loading...</div>
                </div>
            </div>`;

            const pendingList = document.getElementById('pending-payouts-list');
            const pendingQuery = query(collection(db, "payouts"), where("status", "==", "pending"), orderBy("requestedAt", "asc"));
            onSnapshot(pendingQuery, (snapshot) => {
                 pendingList.innerHTML = snapshot.empty ? `<p class="text-gray-500">No pending requests.</p>` : createPayoutsTable(snapshot.docs, true);
            });

            const processedList = document.getElementById('processed-payouts-list');
            const processedQuery = query(collection(db, "payouts"), where("status", "in", ["approved", "rejected"]), orderBy("processedAt", "desc"));
             onSnapshot(processedQuery, (snapshot) => {
                 processedList.innerHTML = snapshot.empty ? `<p class="text-gray-500">No processed payouts.</p>` : createPayoutsTable(snapshot.docs, false);
            });
        }

        function createPayoutsTable(docs, isPending) {
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="th">User</th><th class="th">Amount</th><th class="th">Date Requested</th>
                            ${isPending ? '<th class="th">Actions</th>' : '<th class="th">Status</th>'}
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${docs.map(doc => {
                                const p = { id: doc.id, ...doc.data() };
                                return `<tr>
                                    <td class="td">${p.userName || p.userId}</td>
                                    <td class="td font-medium text-gray-900">$${p.amount.toFixed(2)}</td>
                                    <td class="td">${p.requestedAt.toDate().toLocaleDateString()}</td>
                                    ${isPending 
                                        ? `<td class="td space-x-2">
                                            <button data-action="approve-payout" data-id="${p.id}" data-user-id="${p.userId}" data-amount="${p.amount}" class="btn-sm bg-green-500 hover:bg-green-600 text-white">Approve</button>
                                            <button data-action="reject-payout" data-id="${p.id}" class="btn-sm bg-red-500 hover:bg-red-600 text-white">Reject</button>
                                          </td>`
                                        : `<td class="td"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${p.status}</span></td>`
                                    }
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- ACTION HANDLERS ---

        async function handleCreateRelease() { 
            showToast("Release submission logic not yet implemented.", "error");
            // 1. Validate form
            // 2. Upload files to Cloudinary
            // 3. Collect all data from form fields
            // 4. Save to Firestore 'releases' collection
        }

        async function handleSavePaymentInfo() {
            showLoading(true);
            const method = document.getElementById('payment-method').value;
            const data = { method };

            if (method === 'paypal') {
                data.paypalEmail = document.getElementById('paypal-email').value;
                if (!data.paypalEmail) { showToast('PayPal email is required.', 'error'); showLoading(false); return; }
            } else {
                data.legalName = document.getElementById('legal-name').value;
                data.mailingAddress = document.getElementById('mailing-address').value;
                if (!data.legalName || !data.mailingAddress) { showToast('Name and address are required.', 'error'); showLoading(false); return; }
            }
            
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { paymentInfo: data });
                showToast('Payment information saved!');
            } catch(error) {
                console.error("Error saving payment info: ", error);
                showToast('Failed to save payment information.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function handleRequestPayout() {
            const amountEl = document.getElementById('payout-amount');
            const amount = parseFloat(amountEl.value);
            if (isNaN(amount) || amount <= 0) { showToast('Please enter a valid amount.', 'error'); return; }
            if (amount > currentUserData.balance) { showToast('Amount exceeds your balance.', 'error'); return; }

            showLoading(true);
            try {
                await addDoc(collection(db, "payouts"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    amount,
                    status: 'pending',
                    requestedAt: serverTimestamp(),
                    paymentInfo: currentUserData.paymentInfo
                });
                showToast(`Payout request for $${amount.toFixed(2)} submitted.`);
                amountEl.value = '';
            } catch (error) {
                console.error("Error requesting payout: ", error);
                showToast('Could not submit payout request.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleApprovePayout(payoutId, userId, amount) {
            showLoading(true);
            const userRef = doc(db, "users", userId);
            const payoutRef = doc(db, "payouts", payoutId);

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().balance < amount) {
                        throw "Insufficient user balance!";
                    }
                    transaction.update(userRef, { balance: increment(-amount) });
                    transaction.update(payoutRef, { status: 'approved', processedAt: serverTimestamp() });
                });
                showToast('Payout approved and user balance updated.', 'success');
            } catch(error) {
                console.error("Payout Approval Error: ", error);
                showToast(`Error: ${error}`, 'error');
                if (error === "Insufficient user balance!") {
                    await updateDoc(payoutRef, { status: 'rejected', reason: 'Insufficient balance at time of processing.' });
                }
            } finally {
                showLoading(false);
            }
        }

        async function handleRejectPayout(payoutId, reason) {
            showLoading(true);
            try {
                await updateDoc(doc(db, "payouts", payoutId), {
                    status: 'rejected', reason, processedAt: serverTimestamp()
                });
                showToast('Payout has been rejected.', 'success');
            } catch (error) {
                console.error("Error rejecting payout: ", error);
                showToast('Failed to reject payout.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- UTILITY & PLACEHOLDER FUNCTIONS ---
        function getStatusClass(status) {
            const classes = {
                delivered: 'bg-green-100 text-green-800',
                approved: 'bg-green-100 text-green-800',
                in_review: 'bg-yellow-100 text-yellow-800',
                pending: 'bg-yellow-100 text-yellow-800',
                rejected: 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }
        
        async function renderUserDashboard() { contentArea.innerHTML = `<p>Dashboard coming soon.</p>`; }
        async function renderAnalytics() { contentArea.innerHTML = `<p>Analytics coming soon.</p>`; }
        async function renderAdminReleases() { contentArea.innerHTML = `<p>Admin releases view coming soon.</p>`; }
        async function renderAdminUsers() { contentArea.innerHTML = `<p>Admin users view coming soon.</p>`; }
    </script>

</body>
</html>
